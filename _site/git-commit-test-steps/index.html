<h1 id="how-to-create-a-git-commit-the-hard-way-with-the-github-api">How to create a Git commit (the hard way!) with the GitHub API</h1>

<p>This is a walkthrough for how to make a Git commit the hard way using the GitHub API, testing the steps with cURL via the command line. <strong>The easy way:</strong> If you just want to update or create a <em>single</em> file, you can do it the easy way following the API docs here: https://developer.github.com/v3/repos/contents/</p>

<h2 id="prerequisites">Prerequisites</h2>
<ul>
  <li>A good tutorial to go through first is the official <a href="https://developer.github.com/guides/getting-started/">GitHub API Getting Started Guide</a>.</li>
  <li>For a better understanding of how Git works, read https://git-scm.com/book/en/v2/Git-Internals-Git-Objects</li>
</ul>

<h2 id="setup">Setup</h2>
<ul>
  <li>Make sure you have <a href="https://curl.haxx.se/">cURL</a> installed; we’ll be using it to make GET and POST requests to GitHub’s API via the command line.</li>
  <li><a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/">Create a GitHub personal access token</a> and choose the <code class="highlighter-rouge">repo</code> scope to make sure you have the permissions required to access your GitHub repositories through the API. Save the generated access token somewhere safe, and treat it like a password! Don’t share it with anyone or publish it anywhere!</li>
  <li>When running the code snippets below, replace <code class="highlighter-rouge">TOKEN-GOES-HERE</code> with your new personal access token.</li>
</ul>

<h2 id="sources">Sources</h2>
<ul>
  <li>https://developer.github.com/v3/git/</li>
  <li>https://developer.github.com/v3/repos/</li>
  <li>http://www.nolim1t.co/2017/03/08/uploading-to-github-through-the-API.html</li>
  <li>https://mdswanson.com/blog/2011/07/23/digging-around-the-github-api-take-2.html</li>
</ul>

<h2 id="get-the-sha-of-the-previous-commit">1. Get the SHA of the previous commit</h2>

<p><strong>API Docs: https://developer.github.com/v3/git/refs/#get-a-reference</strong></p>

<p>To access the latest commit, get a reference to the HEAD of the desired branch by making a GET request to <code class="highlighter-rouge">/repos/:user/:repo/git/refs/heads/:branch</code>. For example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -i -H 'Authorization: token TOKEN-GOES-HERE' https://api.github.com/repos/LearnTeachCode/git-notes/git/refs/heads/master
</code></pre>
</div>

<p>GitHub will send a response containing some JSON data for the requested commit. Here’s the important bit:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"object": {
    "sha": "d176c1442aa83adfbcf9746464fd4733bf1106d6",
    "type": "commit",
    "url": "https://api.github.com/repos/LearnTeachCode/git-notes/git/commits/d176c1442aa83adfbcf9746464fd4733bf1106d6"
  }
</code></pre>
</div>

<p>Save the SHA, because we’ll need it for the next steps!</p>

<h2 id="get-the-tree-of-the-previous-commit">2. Get the tree of the previous commit</h2>

<p><strong>API Docs: https://developer.github.com/v3/git/trees/#get-a-tree</strong></p>

<p>Using the SHA saved from Step 1, make a GET request to <code class="highlighter-rouge">/repos/:owner/:repo/git/trees/:sha</code>. For example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -i -H 'Authorization: token TOKEN-GOES-HERE' https://api.github.com/repos/LearnTeachCode/git-notes/git/commits/d176c1442aa83adfbcf9746464fd4733bf1106d6
</code></pre>
</div>

<p>GitHub will send a response with the data for the requested tree. (In Git, trees represent the hierarchy of files and folders. A tree contains references to files, called blobs, or sub-folders, called trees.) Looking at the response, here’s the important part:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"tree": {
    "sha": "60eeced8d029c08d6ef8c3ac5ee806ac048b2aba",
    "url": "https://api.github.com/repos/LearnTeachCode/git-notes/git/trees/60eeced8d029c08d6ef8c3ac5ee806ac048b2aba"
  }
</code></pre>
</div>

<p>Save the SHA of this tree, because we’ll need it for the next steps!</p>

<h2 id="create-a-new-blob-file">3. Create a new blob (file)</h2>

<p><strong>API Docs: https://developer.github.com/v3/git/blobs/#create-a-blob</strong></p>

<p>In Git, files are stored in objects called blobs. Create a new blob by making a POST request to <code class="highlighter-rouge">/repos/:user/:repo/git/blobs</code> with a payload like this: <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"# This is a test!"</span><span class="p">,</span><span class="w"> </span><span class="nt">"encoding"</span><span class="p">:</span><span class="w"> </span><span class="s2">"utf-8"</span><span class="p">}</span></code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -i -H 'Authorization: token TOKEN-GOES-HERE' https://api.github.com/repos/LearnTeachCode/git-notes/git/blobs -d '{"content": "# This is a test!", "encoding": "utf-8"}'
</code></pre>
</div>

<p>After creating the new blob, GitHub’s response will look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"sha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6d24476b2db867038f550c22b68c664cd34d89b1"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.github.com/repos/LearnTeachCode/git-notes/git/blobs/6d24476b2db867038f550c22b68c664cd34d89b1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Save the SHA of the new blob, because we’ll need it for the next steps!</p>

<h2 id="create-new-tree">4. Create new tree</h2>

<p><strong>API Docs: https://developer.github.com/v3/git/trees/#create-a-tree</strong></p>

<p>When creating a new tree, we need to specify the base tree to link it to and the contents of the new tree – in this case, just a single file (the blob we created in Step 3), which we’ll name <code class="highlighter-rouge">test.md</code>. Create a new tree by creating a POST request to <code class="highlighter-rouge">/repos/:user/:repo/git/trees/</code> with the following payload: <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"base_tree"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SHA-FROM-STEP2-GOES-HERE"</span><span class="p">,</span><span class="w"> </span><span class="nt">"tree"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test.md"</span><span class="p">,</span><span class="w"> </span><span class="nt">"mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100644"</span><span class="p">,</span><span class="w"> </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"blob"</span><span class="p">,</span><span class="w"> </span><span class="nt">"sha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SHA-FROM-STEP3-GOES-HERE"</span><span class="p">}]}</span></code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -i -H 'Authorization: token TOKEN-GOES-HERE' https://api.github.com/repos/LearnTeachCode/git-notes/git/trees -d '{"base_tree": "60eeced8d029c08d6ef8c3ac5ee806ac048b2aba", "tree": [{"path": "test.md", "mode": "100644", "type": "blob", "sha": "6d24476b2db867038f550c22b68c664cd34d89b1"}]"}'
</code></pre>
</div>

<p>After creating the new tree, GitHub’s response will show the contents of the new tree, along with the SHA and URL for our newly-created tree:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"sha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"13f7216098033199493d9bc08b141922d3d46985"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.github.com/repos/LearnTeachCode/git-notes/git/trees216098033199493d9bc08b141922d3d46985"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"tree"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="err">//</span><span class="w"> </span><span class="err">...TREE</span><span class="w"> </span><span class="err">DATA</span><span class="w"> </span><span class="err">HERE...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"truncated"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>Save the SHA of the new tree, because – you guessed it! – we’ll need this for the next step!</p>

<h2 id="make-the-commit">5. Make the commit</h2>

<p><strong>API Docs: https://developer.github.com/v3/git/commits/#create-a-commit</strong></p>

<p>Now we can finally make a commit! To create the new commit, make a POST request to <code class="highlighter-rouge">/repos/:user/:repo/git/commits</code> with the payload <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"parents"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"SHA-FROM-STEP1-GOES-HERE"</span><span class="p">],</span><span class="w"> </span><span class="nt">"tree"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SHA-FROM-STEP4-GOES-HERE"</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Testing remote commit via GitHub API"</span><span class="p">}</span></code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -i -H 'Authorization: token TOKEN-GOES-HERE' https://api.github.com/repos/LearnTeachCode/git-notes/git/commits -d '{"parents": ["d176c1442aa83adfbcf9746464fd4733bf1106d6"], "tree": "13f7216098033199493d9bc08b141922d3d46985", "message": "Testing remote commit via GitHub API"}'
</code></pre>
</div>

<p>After creating the new commit, GitHub’s response will show data about the commit and its author (you!), but the only piece we need is the SHA:</p>

<p>```
 {
  “sha”: “59fd06d961f2d65423aaab59139babcb4413486f”,
  “url”: “https://api.github.com/repos/LearnTeachCode/git-notes/git/commits/59fd06d961f2d65423aaab59139babcb4413486f”,
  “html_url”: “https://github.com/LearnTeachCode/git-notes/commit/59fd06d961f2d65423aaab59139babcb4413486f”,<br />
  // …OTHER DATA HERE…
}</p>

<p>```</p>

<p>So once again, save the SHA of the newly-created commit, because we’ll need it for our last step!</p>

<h2 id="move-the-commit-to-the-branch">6. Move the commit to the branch</h2>

<p><strong>API Docs: https://developer.github.com/v3/git/refs/#update-a-reference</strong></p>

<p>For our last step, we’ll update the HEAD reference, pointing it to the new commit by making a PATCH or POST request to <code class="highlighter-rouge">/repos/:user/:repo/git/refs/heads/:branch</code> with the payload <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"sha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SHA-FROM-STEP5-GOES-HERE"</span><span class="p">}</span></code>. In this case, we’re updating the <code class="highlighter-rouge">master</code> branch:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -i -H 'Authorization: token TOKEN-GOES-HERE' https://api.github.com/repos/LearnTeachCode/git-notes/git/refs/heads/master -d '{"sha": "59fd06d961f2d65423aaab59139babcb4413486f"}'
</code></pre>
</div>

<p>Congrats! To check that it worked as expected, take a look at the GitHub project page. A new file named <code class="highlighter-rouge">test.md</code> should now be listed with the rest of the files, and the latest commit should reflect the changes!</p>
